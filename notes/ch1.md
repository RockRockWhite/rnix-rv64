## RISC-V 指令集拓展

由于基于 RISC-V 架构的处理器可能用于嵌入式场景或是通用计算场景，因此指令集规范将指令集划分为最基本的 RV32/64I 以及若干标准指令集拓展。每款处理器只需按照其实际应用场景按需实现指令集拓展即可。

- RV32/64I：每款处理器都必须实现的基本整数指令集。在 RV32I 中，每个通用寄存器的位宽为 32 位；在 RV64I 中则为 64 位。它可以用来模拟绝大多数标准指令集拓展中的指令，除了比较特殊的 A 拓展，因为它需要特别的硬件支持。
- M 拓展：提供整数乘除法相关指令。
- A 拓展：提供原子指令和一些相关的内存同步机制，这个后面会展开。
- F/D 拓展：提供单/双精度浮点数运算支持。
- C 拓展：提供压缩指令拓展。
- G 拓展是基本整数指令集 I 再加上标准指令集拓展 MAFD 的总称，因此 riscv64gc 也就等同于 riscv64imafdc。

## qemu-system-riscv64组成
- 外设：16550A UART，virtio-net/block/
- console/gpu等和设备树
- 硬件特权级：priv v1.10， user v2.2
- 中断控制器：可参数化的CLINT（核心本地中断器）、可参数化的PLIC（平台级中断控制器）
- 可参数化的RAM内存
- 可配置的多核 RV64GC M/S/U mode CPU

内存空间编排
```c
// qemu/hw/riscv/virt.c
static const struct MemmapEntry {
    hwaddr base;
    hwaddr size;
} virt_memmap[] = {
    [VIRT_DEBUG] =       {        0x0,         0x100 },
    [VIRT_MROM] =        {     0x1000,        0xf000 },
    [VIRT_TEST] =        {   0x100000,        0x1000 },
    [VIRT_RTC] =         {   0x101000,        0x1000 },
    [VIRT_CLINT] =       {  0x2000000,       0x10000 },
    [VIRT_PCIE_PIO] =    {  0x3000000,       0x10000 },
    [VIRT_PLIC] =        {  0xc000000, VIRT_PLIC_SIZE(VIRT_CPUS_MAX * 2) },
    [VIRT_UART0] =       { 0x10000000,         0x100 },
    [VIRT_VIRTIO] =      { 0x10001000,        0x1000 },
    [VIRT_FLASH] =       { 0x20000000,     0x4000000 },
    [VIRT_PCIE_ECAM] =   { 0x30000000,    0x10000000 },
    [VIRT_PCIE_MMIO] =   { 0x40000000,    0x40000000 },
    [VIRT_DRAM] =        { 0x80000000,           0x0 },
};
```

## 寄存器表
常见整数寄存器：
|         | 别名   | 描述                                                   |
| ------- | ------ | ------------------------------------------------------ |
| x0      | zero   | 常量零，写入无效，读取始终返回零                       |
| x1      | ra     | 返回地址，用于函数调用的返回                           |
| x2      | sp     | 栈指针，指向栈顶                                       |
| x3      | gp     | 全局指针，通常用于访问全局数据                         |
| x4      | tp     | 线程指针，用于访问线程局部数据                         |
| x5-x7   | t0-t2  | 临时寄存器，不保留任何特殊含义                         |
| x8      | s0/fp  | 基址寄存器，或者称为帧指针，保存调用者的栈帧地址       |
| x9      | s1     | 保留寄存器，用作静态链接寄存器                         |
| x10-x17 | a0-a7  | 参数寄存器，用于函数参数传递                           |
| x18-x27 | s2-s11 | 保留寄存器，用作静态链接寄存器或保存调用者保存的寄存器 |
| x28-x31 | t3-t6  | 临时寄存器，不保留任何特殊含义                         |  

浮点寄存器：  
| 寄存器编号 | 别名 | 描述              |
| ---------- | ---- | ----------------- |
| f0         | ft0  | 浮点临时寄存器 0  |
| f1         | ft1  | 浮点临时寄存器 1  |
| f2         | ft2  | 浮点临时寄存器 2  |
| f3         | ft3  | 浮点临时寄存器 3  |
| f4         | ft4  | 浮点临时寄存器 4  |
| f5         | ft5  | 浮点临时寄存器 5  |
| f6         | ft6  | 浮点临时寄存器 6  |
| f7         | ft7  | 浮点临时寄存器 7  |
| f8         | fs0  | 浮点保存寄存器 0  |
| f9         | fs1  | 浮点保存寄存器 1  |
| f10        | fa0  | 浮点参数寄存器 0  |
| f11        | fa1  | 浮点参数寄存器 1  |
| f12        | fa2  | 浮点参数寄存器 2  |
| f13        | fa3  | 浮点参数寄存器 3  |
| f14        | fa4  | 浮点参数寄存器 4  |
| f15        | fa5  | 浮点参数寄存器 5  |
| f16        | fa6  | 浮点参数寄存器 6  |
| f17        | fa7  | 浮点参数寄存器 7  |
| f18        | fs2  | 浮点保存寄存器 2  |
| f19        | fs3  | 浮点保存寄存器 3  |
| f20        | fs4  | 浮点保存寄存器 4  |
| f21        | fs5  | 浮点保存寄存器 5  |
| f22        | fs6  | 浮点保存寄存器 6  |
| f23        | fs7  | 浮点保存寄存器 7  |
| f24        | fs8  | 浮点保存寄存器 8  |
| f25        | fs9  | 浮点保存寄存器 9  |
| f26        | fs10 | 浮点保存寄存器 10 |
| f27        | fs11 | 浮点保存寄存器 11 |
| f28        | ft8  | 浮点临时寄存器 8  |
| f29        | ft9  | 浮点临时寄存器 9  |
| f30        | ft10 | 浮点临时寄存器 10 |
| f31        | ft11 | 浮点临时寄存器 11 |